name: Build (Arch Linux)

on:
  push:
    branches: [main, master]
    paths:
      - '**.c'
      - '**.h'
      - '**.cpp'
      - '**.scm'
      - 'meson.build'
      - 'meson_options.txt'
      - 'flake.nix'
      - 'protocols/**'
      - '.github/workflows/build-arch.yml'
  pull_request:
    branches: [main, master]
    paths:
      - '**.c'
      - '**.h'
      - '**.cpp'
      - '**.scm'
      - 'meson.build'
      - 'meson_options.txt'
      - 'flake.nix'
      - 'protocols/**'
      - '.github/workflows/build-arch.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check C/C++ code formatting
        run: |
          # Install clang-format
          pacman -Syu --noconfirm
          pacman -S --noconfirm clang
          
          # Check if code is properly formatted
          echo "Checking code formatting with clang-format..."
          clang-format --dry-run --Werror src/*/*.h src/*/*.c src/mango.c mmsg/mmsg.c mmsg/arg.h mmsg/dynarr.h || {
            echo "❌ Code formatting check failed!"
            echo "Run './format.sh' to fix formatting issues."
            exit 1
          }
          echo "✅ Code formatting check passed!"

      - name: Update system and install dependencies
        run: |
          # Install build tools and all dependencies (system already updated in format check)
          pacman -S --noconfirm \
            base-devel \
            git \
            meson \
            ninja \
            wayland \
            wayland-protocols \
            libinput \
            libxkbcommon \
            pcre2 \
            pixman \
            libdrm \
            libxcb \
            xcb-util-wm \
            xorg-xwayland \
            hwdata \
            libliftoff \
            libdisplay-info \
            seatd \
            mesa \
            wlroots0.19 \
            pkg-config
            
      - name: Install scenefx from AUR
        run: |
          # Install scenefx from AUR since it's not in official repos
          # Create a non-root user for makepkg (AUR requires non-root)
          useradd -m -G wheel builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          # Clone and build scenefx from AUR as builder user
          cd /home/builder
          su - builder -c "git clone https://aur.archlinux.org/scenefx0.4.git"
          cd scenefx0.4
          su - builder -c "cd /home/builder/scenefx0.4 && makepkg -si --noconfirm"

      - name: Configure meson
        run: |
          # Download meson subprojects if needed
          meson subprojects download || true
          meson setup build/ --prefix=/usr

      - name: Build project
        run: |
          ninja -C build/

      - name: Build summary
        run: |
          echo "✅ Build completed successfully!"
          echo "Built executables:"
          ls -lh build/mango build/mmsg
